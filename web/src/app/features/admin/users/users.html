<div class="users-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <a routerLink="/" class="back-link">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
      <h1>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h1>
    </div>
    <button type="button" class="btn btn-primary" (click)="openCreateDialog()">
      <span>+</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    </button>
  </div>

  <!-- Search -->
  <app-search-box
    placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô..."
    (search)="onSearch($event)"
  />

  <!-- Table -->
  <div class="table-container">
    @if (isLoading()) {
      <div class="loading-overlay">
        <div class="spinner"></div>
      </div>
    }

    <table class="data-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
          <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
          <th>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
          <th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody>
        @for (user of users(); track user.id) {
          <tr>
            <td>{{ user.id }}</td>
            <td>{{ user.username }}</td>
            <td>{{ user.email }}</td>
            <td>{{ formatDate(user.created_at) }}</td>
            <td class="actions">
              <button type="button" class="btn-icon" title="‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó" (click)="openRoleDialog(user)">üé≠</button>
              <button type="button" class="btn-icon" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" (click)="openEditDialog(user)">‚úèÔ∏è</button>
              <button type="button" class="btn-icon btn-danger" title="‡∏•‡∏ö" (click)="openDeleteDialog(user)">üóëÔ∏è</button>
            </td>
          </tr>
        } @empty {
          <tr>
            <td colspan="5" class="empty-state">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  @if (pagination()) {
    <div class="pagination-info">
      <div class="per-page-selector">
        <label for="per-page">‡πÅ‡∏™‡∏î‡∏á</label>
        <select id="per-page" [value]="perPage()" (change)="onPerPageChange($event)">
          @for (option of perPageOptions; track option) {
            <option [value]="option">{{ option }}</option>
          }
        </select>
        <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
      </div>
     @if (totalPages() > 1) {
        <app-pagination
          [currentPage]="currentPage()"
          [totalPages]="totalPages()"
          (pageChange)="onPageChange($event)"
        />
      } @else {
        <span class="page-info">‡∏´‡∏ô‡πâ‡∏≤ {{ currentPage() }} ‡∏à‡∏≤‡∏Å {{ totalPages() }}</span>
      }
      <span class="total-count">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {{ pagination()?.total ?? 0 }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
    </div>
  }
</div>

<!-- Create Dialog -->
<app-dialog [isOpen]="isCreateDialogOpen()" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" (close)="closeCreateDialog()">
  <form [formGroup]="createForm" (ngSubmit)="submitCreate()">
    <div class="form-group">
      <label for="create-username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
      <input id="create-username" type="text" formControlName="username" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" />
      @if (createForm.controls.username.touched && createForm.controls.username.errors) {
        <span class="error">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</span>
      }
    </div>
    <div class="form-group">
      <label for="create-email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
      <input id="create-email" type="email" formControlName="email" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•" />
      @if (createForm.controls.email.touched && createForm.controls.email.errors) {
        <span class="error">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
      }
    </div>
    <div class="form-group">
      <label for="create-password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
      <input id="create-password" type="password" formControlName="password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />
      @if (createForm.controls.password.touched && createForm.controls.password.errors) {
        <span class="error">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</span>
      }
    </div>
    <div class="dialog-actions">
      <button type="button" class="btn btn-secondary" (click)="closeCreateDialog()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button type="submit" class="btn btn-primary" [disabled]="isSubmitting()">
        @if (isSubmitting()) { ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... } @else { ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å }
      </button>
    </div>
  </form>
</app-dialog>

<!-- Edit Dialog -->
<app-dialog [isOpen]="isEditDialogOpen()" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" (close)="closeEditDialog()">
  <form [formGroup]="editForm" (ngSubmit)="submitEdit()">
    <div class="form-group">
      <label for="edit-username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
      <input id="edit-username" type="text" formControlName="username" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" />
      @if (editForm.controls.username.touched && editForm.controls.username.errors) {
        <span class="error">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</span>
      }
    </div>
    <div class="form-group">
      <label for="edit-email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
      <input id="edit-email" type="email" formControlName="email" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•" />
      @if (editForm.controls.email.touched && editForm.controls.email.errors) {
        <span class="error">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
      }
    </div>
    <div class="dialog-actions">
      <button type="button" class="btn btn-secondary" (click)="closeEditDialog()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button type="submit" class="btn btn-primary" [disabled]="isSubmitting()">
        @if (isSubmitting()) { ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... } @else { ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å }
      </button>
    </div>
  </form>
</app-dialog>

<!-- Delete Confirmation Dialog -->
<app-dialog [isOpen]="isDeleteDialogOpen()" title="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö" (close)="closeDeleteDialog()">
  <div class="confirm-content">
    <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô <strong>{{ selectedUser()?.username }}</strong> ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
    <p class="warning">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
  </div>
  <div class="dialog-actions">
    <button type="button" class="btn btn-secondary" (click)="closeDeleteDialog()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    <button type="button" class="btn btn-danger" [disabled]="isSubmitting()" (click)="confirmDelete()">
      @if (isSubmitting()) { ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö... } @else { ‡∏•‡∏ö }
    </button>
  </div>
</app-dialog>

<!-- Role Management Dialog -->
<app-dialog [isOpen]="isRoleDialogOpen()" title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó" (close)="closeRoleDialog()">
  <div class="role-content">
    <p class="role-user">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <strong>{{ selectedUser()?.username }}</strong></p>
    <div class="role-list">
      @for (role of roles(); track role.id) {
        <label class="role-item">
          <input
            type="checkbox"
            [checked]="hasRole(role.id)"
            (change)="toggleRole(role.id)"
          />
          <span class="role-name">{{ role.name }}</span>
        </label>
      } @empty {
        <p class="empty-state">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</p>
      }
    </div>
  </div>
  <div class="dialog-actions">
    <button type="button" class="btn btn-secondary" (click)="closeRoleDialog()">‡∏õ‡∏¥‡∏î</button>
  </div>
</app-dialog>
